import"./components-BVSRcDa7.js";import{g as B,a as w,s as I}from"./supabase-client-DwhNdNLI.js";import{g as h,a as x,b as L,c as C,d as f}from"./weather-api-C0BSZ2bx.js";import{i as k,a as M}from"./favorites-CsT8pkBu.js";import{g as b,a as T,b as D,s as F,c as S,d as H}from"./storage-xgazSgyw.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm";let s=null,d=null,r={city:"",latitude:0,longitude:0};async function $(){s=await B(),s?(d=await w(s.id),d&&(document.getElementById("userName").textContent=d.first_name||d.email,document.getElementById("logoutBtn").style.display="inline-block",document.getElementById("loginBtn").style.display="none",y(d.theme_preference||"light"))):(document.getElementById("loginBtn").style.display="inline-block",document.getElementById("logoutBtn").style.display="none",y(b())),W(),await j(),p(),setTimeout(()=>{document.getElementById("loader").classList.add("hidden")},1e3)}function W(){document.getElementById("searchBtn").addEventListener("click",g),document.getElementById("citySearch").addEventListener("keypress",t=>{t.key==="Enter"&&g()}),document.getElementById("geolocBtn").addEventListener("click",z);const e=document.getElementById("logoutBtn");e&&e.addEventListener("click",R),document.getElementById("themeToggle").addEventListener("click",U),document.getElementById("addFavoriteBtn").addEventListener("click",N),document.getElementById("mobileMenuToggle").addEventListener("click",_)}function _(){document.getElementById("navMenu").classList.toggle("active")}async function j(){try{const e=T();if(e){await u(e.lat,e.lon,!1,e.city);return}const t=await h();await u(t.latitude,t.longitude,!0)}catch{await v("Paris")}}async function g(){const e=document.getElementById("citySearch").value.trim();if(!e){c("Veuillez entrer un nom de ville");return}await v(e)}async function z(){try{E();const e=await h();await u(e.latitude,e.longitude,!0),m()}catch{m(),c("Impossible d'obtenir votre position. Veuillez activer la g√©olocalisation.")}}async function v(e){try{E();const t=await C(e);await u(t.latitude,t.longitude,!1,t.name),m()}catch(t){m(),t.message==="Ville introuvable"?c("Ville introuvable. Veuillez v√©rifier l'orthographe."):c("Erreur lors de la recherche de la ville")}}async function u(e,t,o=!1,n=null){try{const a=await x(e,t);if(!n&&o&&(n=await L(e,t)),r={city:n||"Position actuelle",latitude:e,longitude:t},S(r.city,e,t),H(r.city,e,t),p(),P(a,n||"Position actuelle"),s){const i=await k(s.id,r.city),l=document.getElementById("addFavoriteBtn");l.style.display="block",l.textContent=i?"D√©j√† dans les favoris":"Ajouter aux favoris",l.disabled=i}}catch{c("Erreur de r√©cup√©ration des donn√©es m√©t√©o")}}function P(e,t){const o=e.current_weather,n=f(o.weathercode);document.getElementById("weatherLocation").textContent=t,document.getElementById("weatherDate").textContent=new Date().toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),document.getElementById("weatherIcon").textContent=n.icon,document.getElementById("weatherTemp").textContent=Math.round(o.temperature)+"¬∞C",document.getElementById("weatherDescription").textContent=n.description;const a=new Date().getHours();document.getElementById("weatherPrecip").textContent=(e.hourly.precipitation[a]||0)+" mm",document.getElementById("weatherWind").textContent=Math.round(o.windspeed)+" km/h",document.getElementById("weatherHumidity").textContent="65%",V(e.daily)}function V(e){const t=document.getElementById("forecastContainer");t.innerHTML="";for(let o=1;o<Math.min(e.time.length,8);o++){const n=new Date(e.time[o]),a=f(e.weather_code[o]),i=document.createElement("div");i.className="favorite-card",i.style.textAlign="center",i.innerHTML=`
      <div style="font-weight: 600; color: var(--dark-blue); margin-bottom: 10px;">
        ${n.toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}
      </div>
      <div style="font-size: 48px; margin: 10px 0;">${a.icon}</div>
      <div style="font-size: 20px; font-weight: 600; color: var(--text-dark);">
        ${Math.round(e.temperature_2m_max[o])}¬∞ / ${Math.round(e.temperature_2m_min[o])}¬∞
      </div>
      <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
        ${a.description}
      </div>
    `,t.appendChild(i)}document.getElementById("forecastSection").style.display="block"}function p(){const e=D(),t=document.getElementById("historyContainer"),o=document.getElementById("historySection");if(!e||e.length===0){o.style.display="none";return}o.style.display="block",t.innerHTML="",e.forEach(n=>{const a=document.createElement("div");a.className="history-card",a.innerHTML=`
      <div class="history-city">${n.city}</div>
      <div class="history-time">${A(n.timestamp)}</div>
    `,a.addEventListener("click",()=>{u(n.lat,n.lon,!1,n.city)}),t.appendChild(a)})}function A(e){const t=new Date,o=new Date(e),n=t-o,a=Math.floor(n/6e4),i=Math.floor(n/36e5),l=Math.floor(n/864e5);return a<60?`Il y a ${a} min`:i<24?`Il y a ${i}h`:`Il y a ${l}j`}async function N(){if(!s||!r.city){c("Veuillez vous connecter pour ajouter des favoris");return}try{await M(s.id,r.city,r.latitude,r.longitude),G("Ville ajout√©e aux favoris"),document.getElementById("addFavoriteBtn").textContent="D√©j√† dans les favoris",document.getElementById("addFavoriteBtn").disabled=!0}catch{c("Erreur lors de l'ajout aux favoris")}}async function R(){try{await I(),window.location.reload()}catch{c("Erreur lors de la d√©connexion")}}function U(){const t=(document.documentElement.getAttribute("data-theme")||"light")==="light"?"dark":"light";y(t),F(t)}function y(e){document.documentElement.setAttribute("data-theme",e);const t=document.getElementById("themeToggle");t.textContent=e==="light"?"üåô":"‚òÄÔ∏è"}function E(){document.getElementById("loader").classList.remove("hidden")}function m(){document.getElementById("loader").classList.add("hidden")}function c(e){const t=document.getElementById("errorMessage");t.textContent=e,t.className="error-message",t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}function G(e){const t=document.getElementById("successMessage");t.textContent=e,t.className="success-message",t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}$();
