import"./components-BVSRcDa7.js";import{createClient as F}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";const _="https://djpigduzgtzlktpyhhgf.supabase.co",S="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcGlnZHV6Z3R6bGt0cHloaGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTMwMzQsImV4cCI6MjA3NjcyOTAzNH0.xqxv2LGs-dXSXDg_ccXzhAY02lP8KxOZ_TpXXZlmAUQ",m=F(_,S);let s=null,l={city:"",lat:0,lon:0};async function T(){if(console.log("Init app"),s=await J(),s){const e=await R(s.id);e&&(document.getElementById("userName").textContent=e.first_name||e.email,document.getElementById("userInfo").style.display="flex",document.getElementById("authButtons").style.display="none")}else document.getElementById("authButtons").style.display="flex";M(),await A(),I(),setTimeout(()=>{const e=document.getElementById("site-loader");e&&(e.classList.add("hidden"),setTimeout(()=>e.remove(),600))},1e3)}function M(){var t,n,o,a,i,c,r;(t=document.getElementById("searchBtn"))==null||t.addEventListener("click",w);const e=document.getElementById("citySearch");e&&(e.addEventListener("keypress",y=>{y.key==="Enter"&&w()}),e.addEventListener("input",v),e.addEventListener("focus",v),document.addEventListener("click",y=>{y.target.closest(".search-wrapper")||f()})),(n=document.getElementById("geolocBtn"))==null||n.addEventListener("click",$),(o=document.getElementById("themeToggle"))==null||o.addEventListener("click",z),(a=document.getElementById("mobileMenuToggle"))==null||a.addEventListener("click",x),(i=document.getElementById("logoutBtn"))==null||i.addEventListener("click",q),(c=document.getElementById("addFavoriteBtn"))==null||c.addEventListener("click",P),(r=document.getElementById("addAlertBtn"))==null||r.addEventListener("click",D)}function x(){var e;(e=document.getElementById("navMenu"))==null||e.classList.toggle("active")}const k=[{name:"Paris",country:"France",lat:48.8566,lon:2.3522},{name:"Marseille",country:"France",lat:43.2965,lon:5.3698},{name:"Lyon",country:"France",lat:45.764,lon:4.8357},{name:"Toulouse",country:"France",lat:43.6047,lon:1.4442},{name:"Nice",country:"France",lat:43.7102,lon:7.262},{name:"Nantes",country:"France",lat:47.2184,lon:-1.5536},{name:"Strasbourg",country:"France",lat:48.5734,lon:7.7521},{name:"Bordeaux",country:"France",lat:44.8378,lon:-.5792},{name:"Lille",country:"France",lat:50.6292,lon:3.0573},{name:"Rennes",country:"France",lat:48.1173,lon:-1.6778},{name:"Montpellier",country:"France",lat:43.6108,lon:3.8767},{name:"Reims",country:"France",lat:49.2583,lon:4.0317},{name:"Le Havre",country:"France",lat:49.4944,lon:.1079},{name:"Dijon",country:"France",lat:47.322,lon:5.0415},{name:"Grenoble",country:"France",lat:45.1885,lon:5.7245},{name:"Angers",country:"France",lat:47.4784,lon:-.5632},{name:"Toulon",country:"France",lat:43.1242,lon:5.928},{name:"Brest",country:"France",lat:48.3904,lon:-4.4861},{name:"Clermont-Ferrand",country:"France",lat:45.7772,lon:3.087},{name:"Rouen",country:"France",lat:49.4432,lon:1.0993}];let g;async function v(e){clearTimeout(g);const t=e.target.value.trim().toLowerCase();if(t.length<2){f();return}g=setTimeout(async()=>{const n=k.filter(o=>o.name.toLowerCase().startsWith(t)||o.name.toLowerCase().includes(t)).slice(0,8);if(t.length>=3)try{const i=(await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=5&accept-language=fr`)).json()).filter(r=>r.type==="city"||r.type==="town"||r.type==="village").map(r=>({name:r.name||r.display_name.split(",")[0],country:r.display_name.split(",").pop().trim(),lat:parseFloat(r.lat),lon:parseFloat(r.lon)})),c=[...n];i.forEach(r=>{c.some(y=>y.name===r.name)||c.push(r)}),h(c.slice(0,10))}catch{h(n)}else h(n)},300)}function h(e){const t=document.getElementById("autocompleteList");if(!t||e.length===0){f();return}t.innerHTML=e.map(n=>`
        <div class="autocomplete-item" data-city="${n.name}" data-lat="${n.lat}" data-lon="${n.lon}">
            <span class="autocomplete-city">${n.name}</span>
            <span class="autocomplete-country">${n.country}</span>
        </div>
    `).join(""),t.querySelectorAll(".autocomplete-item").forEach(n=>{n.addEventListener("click",()=>{const o=n.dataset.city,a=parseFloat(n.dataset.lat),i=parseFloat(n.dataset.lon);document.getElementById("citySearch").value=o,u(a,i,!1,o),f()})}),t.style.display="block"}function f(){const e=document.getElementById("autocompleteList");e&&(e.style.display="none")}async function A(){try{const e=K();if(e){await u(e.lat,e.lon,!1,e.city);return}const t=await b();await u(t.latitude,t.longitude,!0)}catch{await E("Paris")}}async function w(){var t;const e=(t=document.getElementById("citySearch"))==null?void 0:t.value.trim();if(!e){d("Veuillez entrer un nom de ville");return}await E(e)}async function $(){try{const e=await b();await u(e.latitude,e.longitude,!0)}catch{d("Impossible d'obtenir votre position")}}async function E(e){try{const t=await X(e);await u(t.latitude,t.longitude,!1,t.name)}catch(t){d(t.message==="Ville introuvable"?"Ville introuvable":"Erreur de recherche")}}async function u(e,t,n=!1,o=null){try{!o&&n&&(o=await Z(e,t));const a=await G(e,t);if(l={city:o||"Position actuelle",lat:e,lon:t},Y(l.city,e,t),Q(l.city,e,t),I(),j(a,o||"Position actuelle"),s){const i=document.getElementById("weatherActions");i&&(i.style.display="flex");const c=await U(s.id,l.city),r=document.getElementById("addFavoriteBtn");r&&(r.textContent=c?"⭐ Déjà en favoris":"⭐ Ajouter aux favoris",r.disabled=c,c&&r.classList.add("active"))}}catch{d("Erreur de récupération des données météo")}}function j(e,t){const n=e.current_weather,o=B(n.weathercode);document.getElementById("weatherLocation").textContent=t,document.getElementById("weatherDate").textContent=new Date().toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),document.getElementById("weatherIcon").textContent=o.icon,document.getElementById("weatherTemp").textContent=Math.round(n.temperature)+"°C",document.getElementById("weatherDescription").textContent=o.description;const a=new Date().getHours();document.getElementById("weatherPrecip").textContent=(e.hourly.precipitation[a]||0).toFixed(1)+" mm",document.getElementById("weatherWind").textContent=Math.round(n.windspeed)+" km/h",N(e.daily)}function N(e){const t=document.getElementById("forecastContainer");if(t){t.innerHTML="";for(let n=1;n<Math.min(e.time.length,8);n++){const o=new Date(e.time[n]),a=B(e.weather_code[n]),i=document.createElement("div");i.className="forecast-card",i.innerHTML=`
            <div class="forecast-date">${o.toLocaleDateString("fr-FR",{weekday:"short",day:"numeric"})}</div>
            <div class="forecast-icon">${a.icon}</div>
            <div class="forecast-temp">${Math.round(e.temperature_2m_max[n])}° / ${Math.round(e.temperature_2m_min[n])}°</div>
            <div class="forecast-desc">${a.description}</div>
        `,t.appendChild(i)}document.getElementById("forecastSection").style.display="block"}}function I(){const e=L(),t=document.getElementById("historyContainer"),n=document.getElementById("historySection");if(!t||!n||!e||e.length===0){n&&(n.style.display="none");return}n.style.display="block",t.innerHTML="",e.forEach(o=>{const a=document.createElement("div");a.className="history-card",a.innerHTML=`
            <div class="history-city">${o.city}</div>
            <div class="history-time">${ee(o.timestamp)}</div>
        `,a.addEventListener("click",()=>u(o.lat,o.lon,!1,o.city)),t.appendChild(a)})}async function P(){if(!s){d("Veuillez vous connecter");return}try{await W(s.id,l.city,l.lat,l.lon),C("Ajouté aux favoris");const e=document.getElementById("addFavoriteBtn");e&&(e.textContent="⭐ Déjà en favoris",e.disabled=!0,e.classList.add("active"))}catch{d("Erreur")}}async function D(){if(!s){d("Veuillez vous connecter");return}const e=H();document.body.appendChild(e),setTimeout(()=>e.classList.add("active"),10)}function H(){const e=document.createElement("div");return e.className="modal-overlay",e.innerHTML=`
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Créer une alerte pour ${l.city}</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Type d'alerte</label>
                    <select class="form-select" id="alertType">
                        <option value="rain">Pluie</option>
                        <option value="wind">Vent</option>
                        <option value="temperature">Température</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="alertOperator">
                        <option value=">">Supérieur à</option>
                        <option value="<">Inférieur à</option>
                        <option value=">=">Supérieur ou égal à</option>
                        <option value="<=">Inférieur ou égal à</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Valeur</label>
                    <input type="number" class="form-input" id="alertValue" placeholder="Ex: 10" step="0.1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary modal-cancel">Annuler</button>
                <button class="btn-primary modal-submit">Créer l'alerte</button>
            </div>
        </div>
    `,e.querySelector(".modal-close").addEventListener("click",()=>p(e)),e.querySelector(".modal-cancel").addEventListener("click",()=>p(e)),e.querySelector(".modal-submit").addEventListener("click",()=>O(e)),e.addEventListener("click",t=>{t.target===e&&p(e)}),e}function p(e){e.classList.remove("active"),setTimeout(()=>e.remove(),300)}async function O(e){const t=document.getElementById("alertType").value,n=document.getElementById("alertOperator").value,o=parseFloat(document.getElementById("alertValue").value);if(isNaN(o)){d("Valeur invalide");return}try{await V(s.id,l.city,l.lat,l.lon,t,n,o),C("Alerte créée avec succès"),p(e)}catch{d("Erreur lors de la création de l'alerte")}}async function V(e,t,n,o,a,i,c){const{error:r}=await m.from("alerts").insert([{user_id:e,city_name:t,latitude:n,longitude:o,alert_type:a,condition_operator:i,condition_value:c}]);if(r)throw r}async function q(){await m.auth.signOut(),window.location.reload()}function z(){const t=(document.documentElement.getAttribute("data-theme")||"light")==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",t),document.getElementById("themeToggle").textContent=t==="light"?"🌙":"☀️",localStorage.setItem("meteorite_theme",t)}async function J(){const{data:{user:e}}=await m.auth.getUser();return e}async function R(e){const{data:t}=await m.from("profiles").select("*").eq("id",e).maybeSingle();return t}async function U(e,t){const{data:n}=await m.from("favorites").select("id").eq("user_id",e).eq("city_name",t).maybeSingle();return!!n}async function W(e,t,n,o){const{error:a}=await m.from("favorites").insert([{user_id:e,city_name:t,latitude:n,longitude:o}]);if(a)throw a}async function X(e){const n=await(await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e)}&format=json&limit=1`)).json();if(!n||n.length===0)throw new Error("Ville introuvable");return{name:n[0].display_name.split(",")[0],latitude:parseFloat(n[0].lat),longitude:parseFloat(n[0].lon)}}async function b(){return new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(n=>e({latitude:n.coords.latitude,longitude:n.coords.longitude}),()=>t(new Error("Erreur")))})}async function G(e,t){const n=`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current_weather=true&hourly=temperature_2m,precipitation,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto`,o=await fetch(n);if(!o.ok)throw new Error("Erreur API");return await o.json()}async function Z(e,t){var n,o;try{const i=await(await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${e}&lon=${t}&format=json`)).json();return((n=i.address)==null?void 0:n.city)||((o=i.address)==null?void 0:o.town)||"Position actuelle"}catch{return"Position actuelle"}}function B(e){return{0:{description:"Ciel dégagé",icon:"☀️"},1:{description:"Dégagé",icon:"🌤"},2:{description:"Nuageux",icon:"⛅"},3:{description:"Couvert",icon:"☁️"},45:{description:"Brouillard",icon:"🌫"},61:{description:"Pluie légère",icon:"🌧"},63:{description:"Pluie modérée",icon:"🌧"},65:{description:"Pluie forte",icon:"🌧"},71:{description:"Neige légère",icon:"🌨"},95:{description:"Orage",icon:"⛈"}}[e]||{description:"Inconnu",icon:"❓"}}function Q(e,t,n){const a=L().filter(i=>i.city!==e);a.unshift({city:e,lat:t,lon:n,timestamp:new Date().toISOString()}),localStorage.setItem("meteorite_history",JSON.stringify(a.slice(0,10)))}function L(){try{return JSON.parse(localStorage.getItem("meteorite_history")||"[]")}catch{return[]}}function Y(e,t,n){localStorage.setItem("meteorite_last_location",JSON.stringify({city:e,lat:t,lon:n}))}function K(){try{return JSON.parse(localStorage.getItem("meteorite_last_location"))}catch{return null}}function ee(e){const t=new Date-new Date(e),n=Math.floor(t/6e4),o=Math.floor(t/36e5),a=Math.floor(t/864e5);return n<60?`Il y a ${n} min`:o<24?`Il y a ${o}h`:`Il y a ${a}j`}function d(e){const t=document.getElementById("errorMessage");t&&(t.textContent=e,t.style.display="block",setTimeout(()=>t.style.display="none",5e3))}function C(e){const t=document.getElementById("successMessage");t&&(t.textContent=e,t.style.display="block",setTimeout(()=>t.style.display="none",5e3))}T();
